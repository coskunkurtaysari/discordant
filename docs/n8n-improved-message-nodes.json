{
  "nodes": [
    {
      "parameters": {
        "url": "={{ $('Enhanced Input Processor').first().json.appUrl || 'http://localhost:3001' }}/api/socket/messages",
        "method": "POST",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "channelId",
              "value": "={{ $('Enhanced Input Processor').first().json.channelId }}"
            },
            {
              "name": "serverId", 
              "value": "={{ $('Enhanced Input Processor').first().json.serverId }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $('Enhanced AI Agent').first().json.output || $('Enhanced AI Agent').first().json.text || 'AI response processing failed' }}"
            },
            {
              "name": "role",
              "value": "system"
            },
            {
              "name": "metadata",
              "value": "={{ JSON.stringify({\n  responseSource: 'n8n-workflow',\n  workflowId: $('Enhanced Input Processor').first().json.workflowId,\n  processingTime: Date.now() - parseInt($('Enhanced Input Processor').first().json.timestamp),\n  originalMessage: $('Enhanced Input Processor').first().json.input,\n  userId: $('Enhanced Input Processor').first().json.userId\n}) }}"
            }
          ]
        },
        "options": {
          "timeout": 30000,
          "retry": {
            "enabled": true,
            "maxRetries": 3
          }
        }
      },
      "id": "improved-save-message",
      "name": "Save AI Response via API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        500,
        -80
      ],
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $('Enhanced Input Processor').first().json.appUrl || 'http://localhost:3001' }}/api/messages",
        "method": "GET",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "channelId",
              "value": "={{ $json.channelId }}"
            },
            {
              "name": "limit",
              "value": "20"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "improved-load-history", 
      "name": "Load Channel History via API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -280,
        -80
      ],
      "continueOnFail": true
    }
  ],
  "connections": {
    "Save AI Response via API": {
      "main": [
        []
      ]
    },
    "Load Channel History via API": {
      "main": [
        []
      ]
    }
  }
} 